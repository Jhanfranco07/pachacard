"use strict";
/*
 * ATTENTION: An "eval-source-map" devtool has been used.
 * This devtool is neither made for production nor for readable output files.
 * It uses "eval()" calls to create a separate source file with attached SourceMaps in the browser devtools.
 * If you are trying to read the output file, select a different devtool (https://webpack.js.org/configuration/devtool/)
 * or disable the default devtool with "devtool: false".
 * If you are looking for production-ready output files, see mode: "production" (https://webpack.js.org/configuration/mode/).
 */
(() => {
var exports = {};
exports.id = "app/api/redeem/route";
exports.ids = ["app/api/redeem/route"];
exports.modules = {

/***/ "@prisma/client":
/*!*********************************!*\
  !*** external "@prisma/client" ***!
  \*********************************/
/***/ ((module) => {

module.exports = require("@prisma/client");

/***/ }),

/***/ "next/dist/compiled/next-server/app-page.runtime.dev.js":
/*!*************************************************************************!*\
  !*** external "next/dist/compiled/next-server/app-page.runtime.dev.js" ***!
  \*************************************************************************/
/***/ ((module) => {

module.exports = require("next/dist/compiled/next-server/app-page.runtime.dev.js");

/***/ }),

/***/ "next/dist/compiled/next-server/app-route.runtime.dev.js":
/*!**************************************************************************!*\
  !*** external "next/dist/compiled/next-server/app-route.runtime.dev.js" ***!
  \**************************************************************************/
/***/ ((module) => {

module.exports = require("next/dist/compiled/next-server/app-route.runtime.dev.js");

/***/ }),

/***/ "node:buffer":
/*!******************************!*\
  !*** external "node:buffer" ***!
  \******************************/
/***/ ((module) => {

module.exports = require("node:buffer");

/***/ }),

/***/ "node:crypto":
/*!******************************!*\
  !*** external "node:crypto" ***!
  \******************************/
/***/ ((module) => {

module.exports = require("node:crypto");

/***/ }),

/***/ "node:util":
/*!****************************!*\
  !*** external "node:util" ***!
  \****************************/
/***/ ((module) => {

module.exports = require("node:util");

/***/ }),

/***/ "(rsc)/./node_modules/.pnpm/next@14.2.5_react-dom@18.3.1_react@18.3.1__react@18.3.1/node_modules/next/dist/build/webpack/loaders/next-app-loader.js?name=app%2Fapi%2Fredeem%2Froute&page=%2Fapi%2Fredeem%2Froute&appPaths=&pagePath=private-next-app-dir%2Fapi%2Fredeem%2Froute.ts&appDir=C%3A%5CUsers%5CPC%5CDownloads%5Cplataforma_descuentos_full%5Capp&pageExtensions=tsx&pageExtensions=ts&pageExtensions=jsx&pageExtensions=js&rootDir=C%3A%5CUsers%5CPC%5CDownloads%5Cplataforma_descuentos_full&isDev=true&tsconfigPath=tsconfig.json&basePath=&assetPrefix=&nextConfigOutput=&preferredRegion=&middlewareConfig=e30%3D!":
/*!*********************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************!*\
  !*** ./node_modules/.pnpm/next@14.2.5_react-dom@18.3.1_react@18.3.1__react@18.3.1/node_modules/next/dist/build/webpack/loaders/next-app-loader.js?name=app%2Fapi%2Fredeem%2Froute&page=%2Fapi%2Fredeem%2Froute&appPaths=&pagePath=private-next-app-dir%2Fapi%2Fredeem%2Froute.ts&appDir=C%3A%5CUsers%5CPC%5CDownloads%5Cplataforma_descuentos_full%5Capp&pageExtensions=tsx&pageExtensions=ts&pageExtensions=jsx&pageExtensions=js&rootDir=C%3A%5CUsers%5CPC%5CDownloads%5Cplataforma_descuentos_full&isDev=true&tsconfigPath=tsconfig.json&basePath=&assetPrefix=&nextConfigOutput=&preferredRegion=&middlewareConfig=e30%3D! ***!
  \*********************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

eval("__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   originalPathname: () => (/* binding */ originalPathname),\n/* harmony export */   patchFetch: () => (/* binding */ patchFetch),\n/* harmony export */   requestAsyncStorage: () => (/* binding */ requestAsyncStorage),\n/* harmony export */   routeModule: () => (/* binding */ routeModule),\n/* harmony export */   serverHooks: () => (/* binding */ serverHooks),\n/* harmony export */   staticGenerationAsyncStorage: () => (/* binding */ staticGenerationAsyncStorage)\n/* harmony export */ });\n/* harmony import */ var next_dist_server_future_route_modules_app_route_module_compiled__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! next/dist/server/future/route-modules/app-route/module.compiled */ \"(rsc)/./node_modules/.pnpm/next@14.2.5_react-dom@18.3.1_react@18.3.1__react@18.3.1/node_modules/next/dist/server/future/route-modules/app-route/module.compiled.js\");\n/* harmony import */ var next_dist_server_future_route_modules_app_route_module_compiled__WEBPACK_IMPORTED_MODULE_0___default = /*#__PURE__*/__webpack_require__.n(next_dist_server_future_route_modules_app_route_module_compiled__WEBPACK_IMPORTED_MODULE_0__);\n/* harmony import */ var next_dist_server_future_route_kind__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! next/dist/server/future/route-kind */ \"(rsc)/./node_modules/.pnpm/next@14.2.5_react-dom@18.3.1_react@18.3.1__react@18.3.1/node_modules/next/dist/server/future/route-kind.js\");\n/* harmony import */ var next_dist_server_lib_patch_fetch__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! next/dist/server/lib/patch-fetch */ \"(rsc)/./node_modules/.pnpm/next@14.2.5_react-dom@18.3.1_react@18.3.1__react@18.3.1/node_modules/next/dist/server/lib/patch-fetch.js\");\n/* harmony import */ var next_dist_server_lib_patch_fetch__WEBPACK_IMPORTED_MODULE_2___default = /*#__PURE__*/__webpack_require__.n(next_dist_server_lib_patch_fetch__WEBPACK_IMPORTED_MODULE_2__);\n/* harmony import */ var C_Users_PC_Downloads_plataforma_descuentos_full_app_api_redeem_route_ts__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! ./app/api/redeem/route.ts */ \"(rsc)/./app/api/redeem/route.ts\");\n\n\n\n\n// We inject the nextConfigOutput here so that we can use them in the route\n// module.\nconst nextConfigOutput = \"\"\nconst routeModule = new next_dist_server_future_route_modules_app_route_module_compiled__WEBPACK_IMPORTED_MODULE_0__.AppRouteRouteModule({\n    definition: {\n        kind: next_dist_server_future_route_kind__WEBPACK_IMPORTED_MODULE_1__.RouteKind.APP_ROUTE,\n        page: \"/api/redeem/route\",\n        pathname: \"/api/redeem\",\n        filename: \"route\",\n        bundlePath: \"app/api/redeem/route\"\n    },\n    resolvedPagePath: \"C:\\\\Users\\\\PC\\\\Downloads\\\\plataforma_descuentos_full\\\\app\\\\api\\\\redeem\\\\route.ts\",\n    nextConfigOutput,\n    userland: C_Users_PC_Downloads_plataforma_descuentos_full_app_api_redeem_route_ts__WEBPACK_IMPORTED_MODULE_3__\n});\n// Pull out the exports that we need to expose from the module. This should\n// be eliminated when we've moved the other routes to the new format. These\n// are used to hook into the route.\nconst { requestAsyncStorage, staticGenerationAsyncStorage, serverHooks } = routeModule;\nconst originalPathname = \"/api/redeem/route\";\nfunction patchFetch() {\n    return (0,next_dist_server_lib_patch_fetch__WEBPACK_IMPORTED_MODULE_2__.patchFetch)({\n        serverHooks,\n        staticGenerationAsyncStorage\n    });\n}\n\n\n//# sourceMappingURL=app-route.js.map//# sourceURL=[module]\n//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiKHJzYykvLi9ub2RlX21vZHVsZXMvLnBucG0vbmV4dEAxNC4yLjVfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0QDE4LjMuMS9ub2RlX21vZHVsZXMvbmV4dC9kaXN0L2J1aWxkL3dlYnBhY2svbG9hZGVycy9uZXh0LWFwcC1sb2FkZXIuanM/bmFtZT1hcHAlMkZhcGklMkZyZWRlZW0lMkZyb3V0ZSZwYWdlPSUyRmFwaSUyRnJlZGVlbSUyRnJvdXRlJmFwcFBhdGhzPSZwYWdlUGF0aD1wcml2YXRlLW5leHQtYXBwLWRpciUyRmFwaSUyRnJlZGVlbSUyRnJvdXRlLnRzJmFwcERpcj1DJTNBJTVDVXNlcnMlNUNQQyU1Q0Rvd25sb2FkcyU1Q3BsYXRhZm9ybWFfZGVzY3VlbnRvc19mdWxsJTVDYXBwJnBhZ2VFeHRlbnNpb25zPXRzeCZwYWdlRXh0ZW5zaW9ucz10cyZwYWdlRXh0ZW5zaW9ucz1qc3gmcGFnZUV4dGVuc2lvbnM9anMmcm9vdERpcj1DJTNBJTVDVXNlcnMlNUNQQyU1Q0Rvd25sb2FkcyU1Q3BsYXRhZm9ybWFfZGVzY3VlbnRvc19mdWxsJmlzRGV2PXRydWUmdHNjb25maWdQYXRoPXRzY29uZmlnLmpzb24mYmFzZVBhdGg9JmFzc2V0UHJlZml4PSZuZXh0Q29uZmlnT3V0cHV0PSZwcmVmZXJyZWRSZWdpb249Jm1pZGRsZXdhcmVDb25maWc9ZTMwJTNEISIsIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7QUFBc0c7QUFDdkM7QUFDYztBQUNnQztBQUM3RztBQUNBO0FBQ0E7QUFDQSx3QkFBd0IsZ0hBQW1CO0FBQzNDO0FBQ0EsY0FBYyx5RUFBUztBQUN2QjtBQUNBO0FBQ0E7QUFDQTtBQUNBLEtBQUs7QUFDTDtBQUNBO0FBQ0EsWUFBWTtBQUNaLENBQUM7QUFDRDtBQUNBO0FBQ0E7QUFDQSxRQUFRLGlFQUFpRTtBQUN6RTtBQUNBO0FBQ0EsV0FBVyw0RUFBVztBQUN0QjtBQUNBO0FBQ0EsS0FBSztBQUNMO0FBQ3VIOztBQUV2SCIsInNvdXJjZXMiOlsid2VicGFjazovL3BsYXRhZm9ybWEtZGVzY3VlbnRvcy8/MmZkZSJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBBcHBSb3V0ZVJvdXRlTW9kdWxlIH0gZnJvbSBcIm5leHQvZGlzdC9zZXJ2ZXIvZnV0dXJlL3JvdXRlLW1vZHVsZXMvYXBwLXJvdXRlL21vZHVsZS5jb21waWxlZFwiO1xuaW1wb3J0IHsgUm91dGVLaW5kIH0gZnJvbSBcIm5leHQvZGlzdC9zZXJ2ZXIvZnV0dXJlL3JvdXRlLWtpbmRcIjtcbmltcG9ydCB7IHBhdGNoRmV0Y2ggYXMgX3BhdGNoRmV0Y2ggfSBmcm9tIFwibmV4dC9kaXN0L3NlcnZlci9saWIvcGF0Y2gtZmV0Y2hcIjtcbmltcG9ydCAqIGFzIHVzZXJsYW5kIGZyb20gXCJDOlxcXFxVc2Vyc1xcXFxQQ1xcXFxEb3dubG9hZHNcXFxccGxhdGFmb3JtYV9kZXNjdWVudG9zX2Z1bGxcXFxcYXBwXFxcXGFwaVxcXFxyZWRlZW1cXFxccm91dGUudHNcIjtcbi8vIFdlIGluamVjdCB0aGUgbmV4dENvbmZpZ091dHB1dCBoZXJlIHNvIHRoYXQgd2UgY2FuIHVzZSB0aGVtIGluIHRoZSByb3V0ZVxuLy8gbW9kdWxlLlxuY29uc3QgbmV4dENvbmZpZ091dHB1dCA9IFwiXCJcbmNvbnN0IHJvdXRlTW9kdWxlID0gbmV3IEFwcFJvdXRlUm91dGVNb2R1bGUoe1xuICAgIGRlZmluaXRpb246IHtcbiAgICAgICAga2luZDogUm91dGVLaW5kLkFQUF9ST1VURSxcbiAgICAgICAgcGFnZTogXCIvYXBpL3JlZGVlbS9yb3V0ZVwiLFxuICAgICAgICBwYXRobmFtZTogXCIvYXBpL3JlZGVlbVwiLFxuICAgICAgICBmaWxlbmFtZTogXCJyb3V0ZVwiLFxuICAgICAgICBidW5kbGVQYXRoOiBcImFwcC9hcGkvcmVkZWVtL3JvdXRlXCJcbiAgICB9LFxuICAgIHJlc29sdmVkUGFnZVBhdGg6IFwiQzpcXFxcVXNlcnNcXFxcUENcXFxcRG93bmxvYWRzXFxcXHBsYXRhZm9ybWFfZGVzY3VlbnRvc19mdWxsXFxcXGFwcFxcXFxhcGlcXFxccmVkZWVtXFxcXHJvdXRlLnRzXCIsXG4gICAgbmV4dENvbmZpZ091dHB1dCxcbiAgICB1c2VybGFuZFxufSk7XG4vLyBQdWxsIG91dCB0aGUgZXhwb3J0cyB0aGF0IHdlIG5lZWQgdG8gZXhwb3NlIGZyb20gdGhlIG1vZHVsZS4gVGhpcyBzaG91bGRcbi8vIGJlIGVsaW1pbmF0ZWQgd2hlbiB3ZSd2ZSBtb3ZlZCB0aGUgb3RoZXIgcm91dGVzIHRvIHRoZSBuZXcgZm9ybWF0LiBUaGVzZVxuLy8gYXJlIHVzZWQgdG8gaG9vayBpbnRvIHRoZSByb3V0ZS5cbmNvbnN0IHsgcmVxdWVzdEFzeW5jU3RvcmFnZSwgc3RhdGljR2VuZXJhdGlvbkFzeW5jU3RvcmFnZSwgc2VydmVySG9va3MgfSA9IHJvdXRlTW9kdWxlO1xuY29uc3Qgb3JpZ2luYWxQYXRobmFtZSA9IFwiL2FwaS9yZWRlZW0vcm91dGVcIjtcbmZ1bmN0aW9uIHBhdGNoRmV0Y2goKSB7XG4gICAgcmV0dXJuIF9wYXRjaEZldGNoKHtcbiAgICAgICAgc2VydmVySG9va3MsXG4gICAgICAgIHN0YXRpY0dlbmVyYXRpb25Bc3luY1N0b3JhZ2VcbiAgICB9KTtcbn1cbmV4cG9ydCB7IHJvdXRlTW9kdWxlLCByZXF1ZXN0QXN5bmNTdG9yYWdlLCBzdGF0aWNHZW5lcmF0aW9uQXN5bmNTdG9yYWdlLCBzZXJ2ZXJIb29rcywgb3JpZ2luYWxQYXRobmFtZSwgcGF0Y2hGZXRjaCwgIH07XG5cbi8vIyBzb3VyY2VNYXBwaW5nVVJMPWFwcC1yb3V0ZS5qcy5tYXAiXSwibmFtZXMiOltdLCJzb3VyY2VSb290IjoiIn0=\n//# sourceURL=webpack-internal:///(rsc)/./node_modules/.pnpm/next@14.2.5_react-dom@18.3.1_react@18.3.1__react@18.3.1/node_modules/next/dist/build/webpack/loaders/next-app-loader.js?name=app%2Fapi%2Fredeem%2Froute&page=%2Fapi%2Fredeem%2Froute&appPaths=&pagePath=private-next-app-dir%2Fapi%2Fredeem%2Froute.ts&appDir=C%3A%5CUsers%5CPC%5CDownloads%5Cplataforma_descuentos_full%5Capp&pageExtensions=tsx&pageExtensions=ts&pageExtensions=jsx&pageExtensions=js&rootDir=C%3A%5CUsers%5CPC%5CDownloads%5Cplataforma_descuentos_full&isDev=true&tsconfigPath=tsconfig.json&basePath=&assetPrefix=&nextConfigOutput=&preferredRegion=&middlewareConfig=e30%3D!\n");

/***/ }),

/***/ "(rsc)/./app/api/redeem/route.ts":
/*!*********************************!*\
  !*** ./app/api/redeem/route.ts ***!
  \*********************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

eval("__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   GET: () => (/* binding */ GET),\n/* harmony export */   POST: () => (/* binding */ POST)\n/* harmony export */ });\n/* harmony import */ var next_server__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! next/server */ \"(rsc)/./node_modules/.pnpm/next@14.2.5_react-dom@18.3.1_react@18.3.1__react@18.3.1/node_modules/next/dist/api/server.js\");\n/* harmony import */ var _lib_token__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! @/lib/token */ \"(rsc)/./lib/token.ts\");\n/* harmony import */ var _lib_prisma__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! @/lib/prisma */ \"(rsc)/./lib/prisma.ts\");\n/* harmony import */ var _lib_rateLimit__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! @/lib/rateLimit */ \"(rsc)/./lib/rateLimit.ts\");\n// app/api/redeem/route.ts\n\n\n\n\nconst ENFORCE_TV = process.env.QR_ENFORCE_TV === \"true\"; // por defecto: false\n/** Extrae la “versión” del token desde el payload (tv o jti) */ function extractTokenVersion(p) {\n    if (!p) return null;\n    if (typeof p.tv !== \"undefined\") {\n        const n = Number(p.tv);\n        return Number.isFinite(n) ? n : null;\n    }\n    if (typeof p.jti !== \"undefined\") {\n        const n = Number(p.jti);\n        return Number.isFinite(n) ? n : null;\n    }\n    return null;\n}\n/** GET: Verifica token y devuelve el dueño del QR (no canjea) */ async function GET(req) {\n    const url = new URL(req.url);\n    const token = url.searchParams.get(\"token\") || \"\";\n    // Anti-abuso sencillo\n    const ip = (req.headers.get(\"x-forwarded-for\") || \"ip\") + (req.headers.get(\"user-agent\") || \"\");\n    if (!(0,_lib_rateLimit__WEBPACK_IMPORTED_MODULE_3__.rateLimit)(ip)) {\n        return next_server__WEBPACK_IMPORTED_MODULE_0__.NextResponse.json({\n            ok: false,\n            message: \"Rate limit excedido\"\n        }, {\n            status: 429\n        });\n    }\n    try {\n        const p = await (0,_lib_token__WEBPACK_IMPORTED_MODULE_1__.verifyQrToken)(token);\n        const userId = String(p.sub ?? \"\");\n        if (!userId) {\n            return next_server__WEBPACK_IMPORTED_MODULE_0__.NextResponse.json({\n                ok: false,\n                message: \"Token inv\\xe1lido\"\n            }, {\n                status: 401\n            });\n        }\n        const u = await _lib_prisma__WEBPACK_IMPORTED_MODULE_2__.prisma.user.findUnique({\n            where: {\n                id: userId\n            },\n            select: {\n                id: true,\n                name: true,\n                email: true,\n                tier: true,\n                status: true,\n                tokenVersion: true\n            }\n        });\n        if (!u || u.status !== \"ACTIVE\") {\n            return next_server__WEBPACK_IMPORTED_MODULE_0__.NextResponse.json({\n                ok: false,\n                message: \"Token/usuario inv\\xe1lido\"\n            }, {\n                status: 401\n            });\n        }\n        // Si decides hacer cumplir la versión del token\n        if (ENFORCE_TV) {\n            const tv = extractTokenVersion(p);\n            if (tv !== null && tv !== u.tokenVersion) {\n                return next_server__WEBPACK_IMPORTED_MODULE_0__.NextResponse.json({\n                    ok: false,\n                    message: \"Token revocado/rotado\"\n                }, {\n                    status: 401\n                });\n            }\n        }\n        return next_server__WEBPACK_IMPORTED_MODULE_0__.NextResponse.json({\n            ok: true,\n            message: \"Token verificado\",\n            user: {\n                id: u.id,\n                name: u.name,\n                email: u.email,\n                tier: u.tier\n            }\n        });\n    } catch  {\n        return next_server__WEBPACK_IMPORTED_MODULE_0__.NextResponse.json({\n            ok: false,\n            message: \"Token inv\\xe1lido o expirado\"\n        }, {\n            status: 401\n        });\n    }\n}\n/** POST: Valida y registra el canje */ async function POST(req) {\n    const url = new URL(req.url);\n    const token = url.searchParams.get(\"token\") || \"\";\n    // Anti-abuso sencillo\n    const ip = (req.headers.get(\"x-forwarded-for\") || \"ip\") + (req.headers.get(\"user-agent\") || \"\");\n    if (!(0,_lib_rateLimit__WEBPACK_IMPORTED_MODULE_3__.rateLimit)(ip)) {\n        return next_server__WEBPACK_IMPORTED_MODULE_0__.NextResponse.json({\n            ok: false,\n            message: \"Rate limit excedido\"\n        }, {\n            status: 429\n        });\n    }\n    try {\n        // 1) Validar token (tomamos el 'sub' como id de usuario)\n        const p = await (0,_lib_token__WEBPACK_IMPORTED_MODULE_1__.verifyQrToken)(token);\n        const userId = String(p.sub ?? \"\");\n        if (!userId) {\n            return next_server__WEBPACK_IMPORTED_MODULE_0__.NextResponse.json({\n                ok: false,\n                message: \"Token inv\\xe1lido\"\n            }, {\n                status: 401\n            });\n        }\n        // 2) Usuario actual desde BD\n        const user = await _lib_prisma__WEBPACK_IMPORTED_MODULE_2__.prisma.user.findUnique({\n            where: {\n                id: userId\n            }\n        });\n        if (!user || user.status !== \"ACTIVE\") {\n            return next_server__WEBPACK_IMPORTED_MODULE_0__.NextResponse.json({\n                ok: false,\n                message: \"Token/usuario inv\\xe1lido\"\n            }, {\n                status: 401\n            });\n        }\n        // (Opcional) Hacer cumplir tokenVersion si lo activas en .env\n        if (ENFORCE_TV) {\n            const tv = extractTokenVersion(p);\n            if (tv !== null && tv !== user.tokenVersion) {\n                return next_server__WEBPACK_IMPORTED_MODULE_0__.NextResponse.json({\n                    ok: false,\n                    message: \"Token revocado/rotado\"\n                }, {\n                    status: 401\n                });\n            }\n        }\n        // 3) Datos enviados por el cajero\n        const body = await req.json().catch(()=>null);\n        const businessCode = String(body?.businessCode || \"\");\n        const discountCode = String(body?.discountCode || \"\");\n        if (!businessCode || !discountCode) {\n            return next_server__WEBPACK_IMPORTED_MODULE_0__.NextResponse.json({\n                ok: false,\n                message: \"Campos requeridos\"\n            }, {\n                status: 400\n            });\n        }\n        const business = await _lib_prisma__WEBPACK_IMPORTED_MODULE_2__.prisma.business.findUnique({\n            where: {\n                code: businessCode\n            }\n        });\n        if (!business || business.status !== \"ACTIVE\") {\n            return next_server__WEBPACK_IMPORTED_MODULE_0__.NextResponse.json({\n                ok: false,\n                message: \"Negocio inv\\xe1lido\"\n            }, {\n                status: 400\n            });\n        }\n        const now = new Date();\n        const d = await _lib_prisma__WEBPACK_IMPORTED_MODULE_2__.prisma.discount.findUnique({\n            where: {\n                code: discountCode\n            }\n        });\n        if (!d || d.status !== \"PUBLISHED\") {\n            return next_server__WEBPACK_IMPORTED_MODULE_0__.NextResponse.json({\n                ok: false,\n                message: \"Descuento inv\\xe1lido\"\n            }, {\n                status: 400\n            });\n        }\n        if (d.startAt > now || d.endAt < now) {\n            return next_server__WEBPACK_IMPORTED_MODULE_0__.NextResponse.json({\n                ok: false,\n                message: \"Vencido o fuera de vigencia\"\n            }, {\n                status: 400\n            });\n        }\n        // 4) Tier del usuario desde BD (no confíes en el token para esto)\n        const tier = user.tier;\n        const tierOk = tier === \"BASIC\" && d.tierBasic || tier === \"NORMAL\" && d.tierNormal || tier === \"PREMIUM\" && d.tierPremium;\n        if (!tierOk) {\n            return next_server__WEBPACK_IMPORTED_MODULE_0__.NextResponse.json({\n                ok: false,\n                message: \"No v\\xe1lido para tu tier\"\n            }, {\n                status: 400\n            });\n        }\n        // 5) Validar que el descuento corresponda al negocio (si está vinculado)\n        if (d.businessId && d.businessId !== business.id) {\n            return next_server__WEBPACK_IMPORTED_MODULE_0__.NextResponse.json({\n                ok: false,\n                message: \"El c\\xf3digo no corresponde a este negocio\"\n            }, {\n                status: 400\n            });\n        }\n        // 6) Límites\n        if (d.limitTotal && d.usedTotal >= d.limitTotal) {\n            return next_server__WEBPACK_IMPORTED_MODULE_0__.NextResponse.json({\n                ok: false,\n                message: \"Agotado\"\n            }, {\n                status: 400\n            });\n        }\n        // ← ESTE conteo es por usuario (asegura que discountId es el ID del descuento)\n        const usedByUser = await _lib_prisma__WEBPACK_IMPORTED_MODULE_2__.prisma.redemption.count({\n            where: {\n                userId,\n                discountId: d.id\n            }\n        });\n        if (d.limitPerUser && usedByUser >= d.limitPerUser) {\n            return next_server__WEBPACK_IMPORTED_MODULE_0__.NextResponse.json({\n                ok: false,\n                message: \"L\\xedmite por usuario alcanzado\"\n            }, {\n                status: 400\n            });\n        }\n        // 7) Registrar canje de forma atómica\n        const result = await _lib_prisma__WEBPACK_IMPORTED_MODULE_2__.prisma.$transaction(async (tx)=>{\n            if (d.limitTotal) {\n                const fresh = await tx.discount.findUnique({\n                    where: {\n                        id: d.id\n                    }\n                });\n                if (!fresh) throw new Error(\"NOTFOUND\");\n                if (fresh.limitTotal && fresh.usedTotal >= fresh.limitTotal) {\n                    throw new Error(\"AGOTADO\");\n                }\n                await tx.discount.update({\n                    where: {\n                        id: d.id\n                    },\n                    data: {\n                        usedTotal: fresh.usedTotal + 1\n                    }\n                });\n            }\n            return await tx.redemption.create({\n                data: {\n                    userId,\n                    discountId: d.id,\n                    businessId: business.id,\n                    channel: \"qr\"\n                }\n            });\n        });\n        return next_server__WEBPACK_IMPORTED_MODULE_0__.NextResponse.json({\n            ok: true,\n            redemptionId: result.id,\n            message: \"Canje registrado\"\n        });\n    } catch (e) {\n        return next_server__WEBPACK_IMPORTED_MODULE_0__.NextResponse.json({\n            ok: false,\n            message: \"Token inv\\xe1lido o expirado\"\n        }, {\n            status: 401\n        });\n    }\n}\n//# sourceURL=[module]\n//# sourceMappingURL=data:application/json;charset=utf-8;base64,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QztZQUN2QkMsSUFBSTtZQUNKa0QsY0FBY1QsT0FBTy9CLEVBQUU7WUFDdkJULFNBQVM7UUFDWDtJQUNGLEVBQUUsT0FBT2tELEdBQUc7UUFDVixPQUFPNUUscURBQVlBLENBQUN3QixJQUFJLENBQ3RCO1lBQUVDLElBQUk7WUFBT0MsU0FBUztRQUE0QixHQUNsRDtZQUFFQyxRQUFRO1FBQUk7SUFFbEI7QUFDRiIsInNvdXJjZXMiOlsid2VicGFjazovL3BsYXRhZm9ybWEtZGVzY3VlbnRvcy8uL2FwcC9hcGkvcmVkZWVtL3JvdXRlLnRzP2I1MDUiXSwic291cmNlc0NvbnRlbnQiOlsiLy8gYXBwL2FwaS9yZWRlZW0vcm91dGUudHNcbmltcG9ydCB7IE5leHRSZXNwb25zZSB9IGZyb20gXCJuZXh0L3NlcnZlclwiO1xuaW1wb3J0IHsgdmVyaWZ5UXJUb2tlbiB9IGZyb20gXCJAL2xpYi90b2tlblwiO1xuaW1wb3J0IHsgcHJpc21hIH0gZnJvbSBcIkAvbGliL3ByaXNtYVwiO1xuaW1wb3J0IHsgcmF0ZUxpbWl0IH0gZnJvbSBcIkAvbGliL3JhdGVMaW1pdFwiO1xuaW1wb3J0IHR5cGUgeyBQcmlzbWEgfSBmcm9tIFwiQHByaXNtYS9jbGllbnRcIjtcblxuY29uc3QgRU5GT1JDRV9UViA9IHByb2Nlc3MuZW52LlFSX0VORk9SQ0VfVFYgPT09IFwidHJ1ZVwiOyAvLyBwb3IgZGVmZWN0bzogZmFsc2VcblxuLyoqIEV4dHJhZSBsYSDigJx2ZXJzacOzbuKAnSBkZWwgdG9rZW4gZGVzZGUgZWwgcGF5bG9hZCAodHYgbyBqdGkpICovXG5mdW5jdGlvbiBleHRyYWN0VG9rZW5WZXJzaW9uKHA6IGFueSk6IG51bWJlciB8IG51bGwge1xuICBpZiAoIXApIHJldHVybiBudWxsO1xuICBpZiAodHlwZW9mIHAudHYgIT09IFwidW5kZWZpbmVkXCIpIHtcbiAgICBjb25zdCBuID0gTnVtYmVyKHAudHYpO1xuICAgIHJldHVybiBOdW1iZXIuaXNGaW5pdGUobikgPyBuIDogbnVsbDtcbiAgfVxuICBpZiAodHlwZW9mIHAuanRpICE9PSBcInVuZGVmaW5lZFwiKSB7XG4gICAgY29uc3QgbiA9IE51bWJlcihwLmp0aSk7XG4gICAgcmV0dXJuIE51bWJlci5pc0Zpbml0ZShuKSA/IG4gOiBudWxsO1xuICB9XG4gIHJldHVybiBudWxsO1xufVxuXG4vKiogR0VUOiBWZXJpZmljYSB0b2tlbiB5IGRldnVlbHZlIGVsIGR1ZcOxbyBkZWwgUVIgKG5vIGNhbmplYSkgKi9cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBHRVQocmVxOiBSZXF1ZXN0KSB7XG4gIGNvbnN0IHVybCA9IG5ldyBVUkwocmVxLnVybCk7XG4gIGNvbnN0IHRva2VuID0gdXJsLnNlYXJjaFBhcmFtcy5nZXQoXCJ0b2tlblwiKSB8fCBcIlwiO1xuXG4gIC8vIEFudGktYWJ1c28gc2VuY2lsbG9cbiAgY29uc3QgaXAgPVxuICAgIChyZXEuaGVhZGVycy5nZXQoXCJ4LWZvcndhcmRlZC1mb3JcIikgfHwgXCJpcFwiKSArXG4gICAgKHJlcS5oZWFkZXJzLmdldChcInVzZXItYWdlbnRcIikgfHwgXCJcIik7XG4gIGlmICghcmF0ZUxpbWl0KGlwKSkge1xuICAgIHJldHVybiBOZXh0UmVzcG9uc2UuanNvbihcbiAgICAgIHsgb2s6IGZhbHNlLCBtZXNzYWdlOiBcIlJhdGUgbGltaXQgZXhjZWRpZG9cIiB9LFxuICAgICAgeyBzdGF0dXM6IDQyOSB9XG4gICAgKTtcbiAgfVxuXG4gIHRyeSB7XG4gICAgY29uc3QgcDogYW55ID0gYXdhaXQgdmVyaWZ5UXJUb2tlbih0b2tlbik7XG4gICAgY29uc3QgdXNlcklkID0gU3RyaW5nKHAuc3ViID8/IFwiXCIpO1xuICAgIGlmICghdXNlcklkKSB7XG4gICAgICByZXR1cm4gTmV4dFJlc3BvbnNlLmpzb24oXG4gICAgICAgIHsgb2s6IGZhbHNlLCBtZXNzYWdlOiBcIlRva2VuIGludsOhbGlkb1wiIH0sXG4gICAgICAgIHsgc3RhdHVzOiA0MDEgfVxuICAgICAgKTtcbiAgICB9XG5cbiAgICBjb25zdCB1ID0gYXdhaXQgcHJpc21hLnVzZXIuZmluZFVuaXF1ZSh7XG4gICAgICB3aGVyZTogeyBpZDogdXNlcklkIH0sXG4gICAgICBzZWxlY3Q6IHtcbiAgICAgICAgaWQ6IHRydWUsXG4gICAgICAgIG5hbWU6IHRydWUsXG4gICAgICAgIGVtYWlsOiB0cnVlLFxuICAgICAgICB0aWVyOiB0cnVlLFxuICAgICAgICBzdGF0dXM6IHRydWUsXG4gICAgICAgIHRva2VuVmVyc2lvbjogdHJ1ZSxcbiAgICAgIH0sXG4gICAgfSk7XG4gICAgaWYgKCF1IHx8IHUuc3RhdHVzICE9PSBcIkFDVElWRVwiKSB7XG4gICAgICByZXR1cm4gTmV4dFJlc3BvbnNlLmpzb24oXG4gICAgICAgIHsgb2s6IGZhbHNlLCBtZXNzYWdlOiBcIlRva2VuL3VzdWFyaW8gaW52w6FsaWRvXCIgfSxcbiAgICAgICAgeyBzdGF0dXM6IDQwMSB9XG4gICAgICApO1xuICAgIH1cblxuICAgIC8vIFNpIGRlY2lkZXMgaGFjZXIgY3VtcGxpciBsYSB2ZXJzacOzbiBkZWwgdG9rZW5cbiAgICBpZiAoRU5GT1JDRV9UVikge1xuICAgICAgY29uc3QgdHYgPSBleHRyYWN0VG9rZW5WZXJzaW9uKHApO1xuICAgICAgaWYgKHR2ICE9PSBudWxsICYmIHR2ICE9PSB1LnRva2VuVmVyc2lvbikge1xuICAgICAgICByZXR1cm4gTmV4dFJlc3BvbnNlLmpzb24oXG4gICAgICAgICAgeyBvazogZmFsc2UsIG1lc3NhZ2U6IFwiVG9rZW4gcmV2b2NhZG8vcm90YWRvXCIgfSxcbiAgICAgICAgICB7IHN0YXR1czogNDAxIH1cbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4gTmV4dFJlc3BvbnNlLmpzb24oe1xuICAgICAgb2s6IHRydWUsXG4gICAgICBtZXNzYWdlOiBcIlRva2VuIHZlcmlmaWNhZG9cIixcbiAgICAgIHVzZXI6IHsgaWQ6IHUuaWQsIG5hbWU6IHUubmFtZSwgZW1haWw6IHUuZW1haWwsIHRpZXI6IHUudGllciB9LFxuICAgIH0pO1xuICB9IGNhdGNoIHtcbiAgICByZXR1cm4gTmV4dFJlc3BvbnNlLmpzb24oXG4gICAgICB7IG9rOiBmYWxzZSwgbWVzc2FnZTogXCJUb2tlbiBpbnbDoWxpZG8gbyBleHBpcmFkb1wiIH0sXG4gICAgICB7IHN0YXR1czogNDAxIH1cbiAgICApO1xuICB9XG59XG5cbi8qKiBQT1NUOiBWYWxpZGEgeSByZWdpc3RyYSBlbCBjYW5qZSAqL1xuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIFBPU1QocmVxOiBSZXF1ZXN0KSB7XG4gIGNvbnN0IHVybCA9IG5ldyBVUkwocmVxLnVybCk7XG4gIGNvbnN0IHRva2VuID0gdXJsLnNlYXJjaFBhcmFtcy5nZXQoXCJ0b2tlblwiKSB8fCBcIlwiO1xuXG4gIC8vIEFudGktYWJ1c28gc2VuY2lsbG9cbiAgY29uc3QgaXAgPVxuICAgIChyZXEuaGVhZGVycy5nZXQoXCJ4LWZvcndhcmRlZC1mb3JcIikgfHwgXCJpcFwiKSArXG4gICAgKHJlcS5oZWFkZXJzLmdldChcInVzZXItYWdlbnRcIikgfHwgXCJcIik7XG4gIGlmICghcmF0ZUxpbWl0KGlwKSkge1xuICAgIHJldHVybiBOZXh0UmVzcG9uc2UuanNvbihcbiAgICAgIHsgb2s6IGZhbHNlLCBtZXNzYWdlOiBcIlJhdGUgbGltaXQgZXhjZWRpZG9cIiB9LFxuICAgICAgeyBzdGF0dXM6IDQyOSB9XG4gICAgKTtcbiAgfVxuXG4gIHRyeSB7XG4gICAgLy8gMSkgVmFsaWRhciB0b2tlbiAodG9tYW1vcyBlbCAnc3ViJyBjb21vIGlkIGRlIHVzdWFyaW8pXG4gICAgY29uc3QgcDogYW55ID0gYXdhaXQgdmVyaWZ5UXJUb2tlbih0b2tlbik7XG4gICAgY29uc3QgdXNlcklkID0gU3RyaW5nKHAuc3ViID8/IFwiXCIpO1xuICAgIGlmICghdXNlcklkKSB7XG4gICAgICByZXR1cm4gTmV4dFJlc3BvbnNlLmpzb24oXG4gICAgICAgIHsgb2s6IGZhbHNlLCBtZXNzYWdlOiBcIlRva2VuIGludsOhbGlkb1wiIH0sXG4gICAgICAgIHsgc3RhdHVzOiA0MDEgfVxuICAgICAgKTtcbiAgICB9XG5cbiAgICAvLyAyKSBVc3VhcmlvIGFjdHVhbCBkZXNkZSBCRFxuICAgIGNvbnN0IHVzZXIgPSBhd2FpdCBwcmlzbWEudXNlci5maW5kVW5pcXVlKHsgd2hlcmU6IHsgaWQ6IHVzZXJJZCB9IH0pO1xuICAgIGlmICghdXNlciB8fCB1c2VyLnN0YXR1cyAhPT0gXCJBQ1RJVkVcIikge1xuICAgICAgcmV0dXJuIE5leHRSZXNwb25zZS5qc29uKFxuICAgICAgICB7IG9rOiBmYWxzZSwgbWVzc2FnZTogXCJUb2tlbi91c3VhcmlvIGludsOhbGlkb1wiIH0sXG4gICAgICAgIHsgc3RhdHVzOiA0MDEgfVxuICAgICAgKTtcbiAgICB9XG5cbiAgICAvLyAoT3BjaW9uYWwpIEhhY2VyIGN1bXBsaXIgdG9rZW5WZXJzaW9uIHNpIGxvIGFjdGl2YXMgZW4gLmVudlxuICAgIGlmIChFTkZPUkNFX1RWKSB7XG4gICAgICBjb25zdCB0diA9IGV4dHJhY3RUb2tlblZlcnNpb24ocCk7XG4gICAgICBpZiAodHYgIT09IG51bGwgJiYgdHYgIT09IHVzZXIudG9rZW5WZXJzaW9uKSB7XG4gICAgICAgIHJldHVybiBOZXh0UmVzcG9uc2UuanNvbihcbiAgICAgICAgICB7IG9rOiBmYWxzZSwgbWVzc2FnZTogXCJUb2tlbiByZXZvY2Fkby9yb3RhZG9cIiB9LFxuICAgICAgICAgIHsgc3RhdHVzOiA0MDEgfVxuICAgICAgICApO1xuICAgICAgfVxuICAgIH1cblxuICAgIC8vIDMpIERhdG9zIGVudmlhZG9zIHBvciBlbCBjYWplcm9cbiAgICBjb25zdCBib2R5ID0gYXdhaXQgcmVxLmpzb24oKS5jYXRjaCgoKSA9PiBudWxsKTtcbiAgICBjb25zdCBidXNpbmVzc0NvZGUgPSBTdHJpbmcoYm9keT8uYnVzaW5lc3NDb2RlIHx8IFwiXCIpO1xuICAgIGNvbnN0IGRpc2NvdW50Q29kZSA9IFN0cmluZyhib2R5Py5kaXNjb3VudENvZGUgfHwgXCJcIik7XG4gICAgaWYgKCFidXNpbmVzc0NvZGUgfHwgIWRpc2NvdW50Q29kZSkge1xuICAgICAgcmV0dXJuIE5leHRSZXNwb25zZS5qc29uKFxuICAgICAgICB7IG9rOiBmYWxzZSwgbWVzc2FnZTogXCJDYW1wb3MgcmVxdWVyaWRvc1wiIH0sXG4gICAgICAgIHsgc3RhdHVzOiA0MDAgfVxuICAgICAgKTtcbiAgICB9XG5cbiAgICBjb25zdCBidXNpbmVzcyA9IGF3YWl0IHByaXNtYS5idXNpbmVzcy5maW5kVW5pcXVlKHtcbiAgICAgIHdoZXJlOiB7IGNvZGU6IGJ1c2luZXNzQ29kZSB9LFxuICAgIH0pO1xuICAgIGlmICghYnVzaW5lc3MgfHwgYnVzaW5lc3Muc3RhdHVzICE9PSBcIkFDVElWRVwiKSB7XG4gICAgICByZXR1cm4gTmV4dFJlc3BvbnNlLmpzb24oXG4gICAgICAgIHsgb2s6IGZhbHNlLCBtZXNzYWdlOiBcIk5lZ29jaW8gaW52w6FsaWRvXCIgfSxcbiAgICAgICAgeyBzdGF0dXM6IDQwMCB9XG4gICAgICApO1xuICAgIH1cblxuICAgIGNvbnN0IG5vdyA9IG5ldyBEYXRlKCk7XG4gICAgY29uc3QgZCA9IGF3YWl0IHByaXNtYS5kaXNjb3VudC5maW5kVW5pcXVlKHtcbiAgICAgIHdoZXJlOiB7IGNvZGU6IGRpc2NvdW50Q29kZSB9LFxuICAgIH0pO1xuICAgIGlmICghZCB8fCBkLnN0YXR1cyAhPT0gXCJQVUJMSVNIRURcIikge1xuICAgICAgcmV0dXJuIE5leHRSZXNwb25zZS5qc29uKFxuICAgICAgICB7IG9rOiBmYWxzZSwgbWVzc2FnZTogXCJEZXNjdWVudG8gaW52w6FsaWRvXCIgfSxcbiAgICAgICAgeyBzdGF0dXM6IDQwMCB9XG4gICAgICApO1xuICAgIH1cbiAgICBpZiAoZC5zdGFydEF0ID4gbm93IHx8IGQuZW5kQXQgPCBub3cpIHtcbiAgICAgIHJldHVybiBOZXh0UmVzcG9uc2UuanNvbihcbiAgICAgICAgeyBvazogZmFsc2UsIG1lc3NhZ2U6IFwiVmVuY2lkbyBvIGZ1ZXJhIGRlIHZpZ2VuY2lhXCIgfSxcbiAgICAgICAgeyBzdGF0dXM6IDQwMCB9XG4gICAgICApO1xuICAgIH1cblxuICAgIC8vIDQpIFRpZXIgZGVsIHVzdWFyaW8gZGVzZGUgQkQgKG5vIGNvbmbDrWVzIGVuIGVsIHRva2VuIHBhcmEgZXN0bylcbiAgICBjb25zdCB0aWVyID0gdXNlci50aWVyO1xuICAgIGNvbnN0IHRpZXJPayA9XG4gICAgICAodGllciA9PT0gXCJCQVNJQ1wiICYmIGQudGllckJhc2ljKSB8fFxuICAgICAgKHRpZXIgPT09IFwiTk9STUFMXCIgJiYgZC50aWVyTm9ybWFsKSB8fFxuICAgICAgKHRpZXIgPT09IFwiUFJFTUlVTVwiICYmIGQudGllclByZW1pdW0pO1xuICAgIGlmICghdGllck9rKSB7XG4gICAgICByZXR1cm4gTmV4dFJlc3BvbnNlLmpzb24oXG4gICAgICAgIHsgb2s6IGZhbHNlLCBtZXNzYWdlOiBcIk5vIHbDoWxpZG8gcGFyYSB0dSB0aWVyXCIgfSxcbiAgICAgICAgeyBzdGF0dXM6IDQwMCB9XG4gICAgICApO1xuICAgIH1cblxuICAgIC8vIDUpIFZhbGlkYXIgcXVlIGVsIGRlc2N1ZW50byBjb3JyZXNwb25kYSBhbCBuZWdvY2lvIChzaSBlc3TDoSB2aW5jdWxhZG8pXG4gICAgaWYgKGQuYnVzaW5lc3NJZCAmJiBkLmJ1c2luZXNzSWQgIT09IGJ1c2luZXNzLmlkKSB7XG4gICAgICByZXR1cm4gTmV4dFJlc3BvbnNlLmpzb24oXG4gICAgICAgIHsgb2s6IGZhbHNlLCBtZXNzYWdlOiBcIkVsIGPDs2RpZ28gbm8gY29ycmVzcG9uZGUgYSBlc3RlIG5lZ29jaW9cIiB9LFxuICAgICAgICB7IHN0YXR1czogNDAwIH1cbiAgICAgICk7XG4gICAgfVxuXG4gICAgLy8gNikgTMOtbWl0ZXNcbiAgICBpZiAoZC5saW1pdFRvdGFsICYmIGQudXNlZFRvdGFsID49IGQubGltaXRUb3RhbCkge1xuICAgICAgcmV0dXJuIE5leHRSZXNwb25zZS5qc29uKFxuICAgICAgICB7IG9rOiBmYWxzZSwgbWVzc2FnZTogXCJBZ290YWRvXCIgfSxcbiAgICAgICAgeyBzdGF0dXM6IDQwMCB9XG4gICAgICApO1xuICAgIH1cblxuICAgIC8vIOKGkCBFU1RFIGNvbnRlbyBlcyBwb3IgdXN1YXJpbyAoYXNlZ3VyYSBxdWUgZGlzY291bnRJZCBlcyBlbCBJRCBkZWwgZGVzY3VlbnRvKVxuICAgIGNvbnN0IHVzZWRCeVVzZXIgPSBhd2FpdCBwcmlzbWEucmVkZW1wdGlvbi5jb3VudCh7XG4gICAgICB3aGVyZTogeyB1c2VySWQsIGRpc2NvdW50SWQ6IGQuaWQgfSxcbiAgICB9KTtcbiAgICBpZiAoZC5saW1pdFBlclVzZXIgJiYgdXNlZEJ5VXNlciA+PSBkLmxpbWl0UGVyVXNlcikge1xuICAgICAgcmV0dXJuIE5leHRSZXNwb25zZS5qc29uKFxuICAgICAgICB7IG9rOiBmYWxzZSwgbWVzc2FnZTogXCJMw61taXRlIHBvciB1c3VhcmlvIGFsY2FuemFkb1wiIH0sXG4gICAgICAgIHsgc3RhdHVzOiA0MDAgfVxuICAgICAgKTtcbiAgICB9XG5cbiAgICAvLyA3KSBSZWdpc3RyYXIgY2FuamUgZGUgZm9ybWEgYXTDs21pY2FcbiAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBwcmlzbWEuJHRyYW5zYWN0aW9uKFxuICAgICAgYXN5bmMgKHR4OiBQcmlzbWEuVHJhbnNhY3Rpb25DbGllbnQpID0+IHtcbiAgICAgICAgaWYgKGQubGltaXRUb3RhbCkge1xuICAgICAgICAgIGNvbnN0IGZyZXNoID0gYXdhaXQgdHguZGlzY291bnQuZmluZFVuaXF1ZSh7IHdoZXJlOiB7IGlkOiBkLmlkIH0gfSk7XG4gICAgICAgICAgaWYgKCFmcmVzaCkgdGhyb3cgbmV3IEVycm9yKFwiTk9URk9VTkRcIik7XG4gICAgICAgICAgaWYgKGZyZXNoLmxpbWl0VG90YWwgJiYgZnJlc2gudXNlZFRvdGFsID49IGZyZXNoLmxpbWl0VG90YWwpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcIkFHT1RBRE9cIik7XG4gICAgICAgICAgfVxuICAgICAgICAgIGF3YWl0IHR4LmRpc2NvdW50LnVwZGF0ZSh7XG4gICAgICAgICAgICB3aGVyZTogeyBpZDogZC5pZCB9LFxuICAgICAgICAgICAgZGF0YTogeyB1c2VkVG90YWw6IGZyZXNoLnVzZWRUb3RhbCArIDEgfSxcbiAgICAgICAgICB9KTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBhd2FpdCB0eC5yZWRlbXB0aW9uLmNyZWF0ZSh7XG4gICAgICAgICAgZGF0YToge1xuICAgICAgICAgICAgdXNlcklkLFxuICAgICAgICAgICAgZGlzY291bnRJZDogZC5pZCxcbiAgICAgICAgICAgIGJ1c2luZXNzSWQ6IGJ1c2luZXNzLmlkLFxuICAgICAgICAgICAgY2hhbm5lbDogXCJxclwiLFxuICAgICAgICAgIH0sXG4gICAgICAgIH0pO1xuICAgICAgfVxuICAgICk7XG5cbiAgICByZXR1cm4gTmV4dFJlc3BvbnNlLmpzb24oe1xuICAgICAgb2s6IHRydWUsXG4gICAgICByZWRlbXB0aW9uSWQ6IHJlc3VsdC5pZCxcbiAgICAgIG1lc3NhZ2U6IFwiQ2FuamUgcmVnaXN0cmFkb1wiLFxuICAgIH0pO1xuICB9IGNhdGNoIChlKSB7XG4gICAgcmV0dXJuIE5leHRSZXNwb25zZS5qc29uKFxuICAgICAgeyBvazogZmFsc2UsIG1lc3NhZ2U6IFwiVG9rZW4gaW52w6FsaWRvIG8gZXhwaXJhZG9cIiB9LFxuICAgICAgeyBzdGF0dXM6IDQwMSB9XG4gICAgKTtcbiAgfVxufVxuIl0sIm5hbWVzIjpbIk5leHRSZXNwb25zZSIsInZlcmlmeVFyVG9rZW4iLCJwcmlzbWEiLCJyYXRlTGltaXQiLCJFTkZPUkNFX1RWIiwicHJvY2VzcyIsImVudiIsIlFSX0VORk9SQ0VfVFYiLCJleHRyYWN0VG9rZW5WZXJzaW9uIiwicCIsInR2IiwibiIsIk51bWJlciIsImlzRmluaXRlIiwianRpIiwiR0VUIiwicmVxIiwidXJsIiwiVVJMIiwidG9rZW4iLCJzZWFyY2hQYXJhbXMiLCJnZXQiLCJpcCIsImhlYWRlcnMiLCJqc29uIiwib2siLCJtZXNzYWdlIiwic3RhdHVzIiwidXNlcklkIiwiU3RyaW5nIiwic3ViIiwidSIsInVzZXIiLCJmaW5kVW5pcXVlIiwid2hlcmUiLCJpZCIsInNlbGVjdCIsIm5hbWUiLCJlbWFpbCIsInRpZXIiLCJ0b2tlblZlcnNpb24iLCJQT1NUIiwiYm9keSIsImNhdGNoIiwiYnVzaW5lc3NDb2RlIiwiZGlzY291bnRDb2RlIiwiYnVzaW5lc3MiLCJjb2RlIiwibm93IiwiRGF0ZSIsImQiLCJkaXNjb3VudCIsInN0YXJ0QXQiLCJlbmRBdCIsInRpZXJPayIsInRpZXJCYXNpYyIsInRpZXJOb3JtYWwiLCJ0aWVyUHJlbWl1bSIsImJ1c2luZXNzSWQiLCJsaW1pdFRvdGFsIiwidXNlZFRvdGFsIiwidXNlZEJ5VXNlciIsInJlZGVtcHRpb24iLCJjb3VudCIsImRpc2NvdW50SWQiLCJsaW1pdFBlclVzZXIiLCJyZXN1bHQiLCIkdHJhbnNhY3Rpb24iLCJ0eCIsImZyZXNoIiwiRXJyb3IiLCJ1cGRhdGUiLCJkYXRhIiwiY3JlYXRlIiwiY2hhbm5lbCIsInJlZGVtcHRpb25JZCIsImUiXSwic291cmNlUm9vdCI6IiJ9\n//# sourceURL=webpack-internal:///(rsc)/./app/api/redeem/route.ts\n");

/***/ }),

/***/ "(rsc)/./lib/prisma.ts":
/*!***********************!*\
  !*** ./lib/prisma.ts ***!
  \***********************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

eval("__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   prisma: () => (/* binding */ prisma)\n/* harmony export */ });\n/* harmony import */ var _prisma_client__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! @prisma/client */ \"@prisma/client\");\n/* harmony import */ var _prisma_client__WEBPACK_IMPORTED_MODULE_0___default = /*#__PURE__*/__webpack_require__.n(_prisma_client__WEBPACK_IMPORTED_MODULE_0__);\n// lib/prisma.ts\n\nconst globalForPrisma = globalThis;\nconst prisma = globalForPrisma.prisma ?? new _prisma_client__WEBPACK_IMPORTED_MODULE_0__.PrismaClient({\n});\nif (true) globalForPrisma.prisma = prisma;\n//# sourceURL=[module]\n//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiKHJzYykvLi9saWIvcHJpc21hLnRzIiwibWFwcGluZ3MiOiI7Ozs7OztBQUFBLGdCQUFnQjtBQUM4QjtBQUU5QyxNQUFNQyxrQkFBa0JDO0FBRWpCLE1BQU1DLFNBQ1hGLGdCQUFnQkUsTUFBTSxJQUN0QixJQUFJSCx3REFBWUEsQ0FBQztBQUVqQixHQUFHO0FBRUwsSUFBSUksSUFBcUMsRUFBRUgsZ0JBQWdCRSxNQUFNLEdBQUdBIiwic291cmNlcyI6WyJ3ZWJwYWNrOi8vcGxhdGFmb3JtYS1kZXNjdWVudG9zLy4vbGliL3ByaXNtYS50cz85ODIyIl0sInNvdXJjZXNDb250ZW50IjpbIi8vIGxpYi9wcmlzbWEudHNcclxuaW1wb3J0IHsgUHJpc21hQ2xpZW50IH0gZnJvbSBcIkBwcmlzbWEvY2xpZW50XCI7XHJcblxyXG5jb25zdCBnbG9iYWxGb3JQcmlzbWEgPSBnbG9iYWxUaGlzIGFzIHVua25vd24gYXMgeyBwcmlzbWE/OiBQcmlzbWFDbGllbnQgfTtcclxuXHJcbmV4cG9ydCBjb25zdCBwcmlzbWEgPVxyXG4gIGdsb2JhbEZvclByaXNtYS5wcmlzbWEgPz9cclxuICBuZXcgUHJpc21hQ2xpZW50KHtcclxuICAgIC8vIGxvZzogWydxdWVyeScsJ2Vycm9yJywnd2FybiddLCAvLyBvcGNpb25hbCBwYXJhIGRlYnVnXHJcbiAgfSk7XHJcblxyXG5pZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09IFwicHJvZHVjdGlvblwiKSBnbG9iYWxGb3JQcmlzbWEucHJpc21hID0gcHJpc21hO1xyXG4iXSwibmFtZXMiOlsiUHJpc21hQ2xpZW50IiwiZ2xvYmFsRm9yUHJpc21hIiwiZ2xvYmFsVGhpcyIsInByaXNtYSIsInByb2Nlc3MiXSwic291cmNlUm9vdCI6IiJ9\n//# sourceURL=webpack-internal:///(rsc)/./lib/prisma.ts\n");

/***/ }),

/***/ "(rsc)/./lib/rateLimit.ts":
/*!**************************!*\
  !*** ./lib/rateLimit.ts ***!
  \**************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

eval("__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   rateLimit: () => (/* binding */ rateLimit)\n/* harmony export */ });\nconst W = Number(process.env.RL_WINDOW_MS || 30000);\nconst M = Number(process.env.RL_MAX_HITS || 10);\nconst b = new Map();\nfunction rateLimit(k) {\n    const n = Date.now();\n    const v = b.get(k) || {\n        h: 0,\n        ts: n\n    };\n    if (n - v.ts > W) {\n        v.h = 0;\n        v.ts = n;\n    }\n    v.h++;\n    b.set(k, v);\n    return v.h <= M;\n}\n//# sourceURL=[module]\n//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiKHJzYykvLi9saWIvcmF0ZUxpbWl0LnRzIiwibWFwcGluZ3MiOiI7Ozs7QUFBQSxNQUFNQSxJQUFFQyxPQUFPQyxRQUFRQyxHQUFHLENBQUNDLFlBQVksSUFBRTtBQUFRLE1BQU1DLElBQUVKLE9BQU9DLFFBQVFDLEdBQUcsQ0FBQ0csV0FBVyxJQUFFO0FBQUssTUFBTUMsSUFBRSxJQUFJQztBQUEyQyxTQUFTQyxVQUFVQyxDQUFRO0lBQUUsTUFBTUMsSUFBRUMsS0FBS0MsR0FBRztJQUFJLE1BQU1DLElBQUVQLEVBQUVRLEdBQUcsQ0FBQ0wsTUFBSTtRQUFDTSxHQUFFO1FBQUVDLElBQUdOO0lBQUM7SUFBRyxJQUFHQSxJQUFFRyxFQUFFRyxFQUFFLEdBQUNqQixHQUFFO1FBQUNjLEVBQUVFLENBQUMsR0FBQztRQUFFRixFQUFFRyxFQUFFLEdBQUNOO0lBQUU7SUFBRUcsRUFBRUUsQ0FBQztJQUFJVCxFQUFFVyxHQUFHLENBQUNSLEdBQUVJO0lBQUksT0FBT0EsRUFBRUUsQ0FBQyxJQUFFWDtBQUFFIiwic291cmNlcyI6WyJ3ZWJwYWNrOi8vcGxhdGFmb3JtYS1kZXNjdWVudG9zLy4vbGliL3JhdGVMaW1pdC50cz8yNWZmIl0sInNvdXJjZXNDb250ZW50IjpbImNvbnN0IFc9TnVtYmVyKHByb2Nlc3MuZW52LlJMX1dJTkRPV19NU3x8MzAwMDApOyBjb25zdCBNPU51bWJlcihwcm9jZXNzLmVudi5STF9NQVhfSElUU3x8MTApOyBjb25zdCBiPW5ldyBNYXA8c3RyaW5nLHtoOm51bWJlcjt0czpudW1iZXJ9PigpOyBleHBvcnQgZnVuY3Rpb24gcmF0ZUxpbWl0KGs6c3RyaW5nKXtjb25zdCBuPURhdGUubm93KCk7IGNvbnN0IHY9Yi5nZXQoayl8fHtoOjAsdHM6bn07IGlmKG4tdi50cz5XKXt2Lmg9MDt2LnRzPW47fSB2LmgrKzsgYi5zZXQoayx2KTsgcmV0dXJuIHYuaDw9TTt9Il0sIm5hbWVzIjpbIlciLCJOdW1iZXIiLCJwcm9jZXNzIiwiZW52IiwiUkxfV0lORE9XX01TIiwiTSIsIlJMX01BWF9ISVRTIiwiYiIsIk1hcCIsInJhdGVMaW1pdCIsImsiLCJuIiwiRGF0ZSIsIm5vdyIsInYiLCJnZXQiLCJoIiwidHMiLCJzZXQiXSwic291cmNlUm9vdCI6IiJ9\n//# sourceURL=webpack-internal:///(rsc)/./lib/rateLimit.ts\n");

/***/ }),

/***/ "(rsc)/./lib/token.ts":
/*!**********************!*\
  !*** ./lib/token.ts ***!
  \**********************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

eval("__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   makeCardToken: () => (/* binding */ makeCardToken),\n/* harmony export */   verifyQrToken: () => (/* binding */ verifyQrToken)\n/* harmony export */ });\n/* harmony import */ var jose__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! jose */ \"(rsc)/./node_modules/.pnpm/jose@5.10.0/node_modules/jose/dist/node/esm/jwt/sign.js\");\n/* harmony import */ var jose__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! jose */ \"(rsc)/./node_modules/.pnpm/jose@5.10.0/node_modules/jose/dist/node/esm/jwt/verify.js\");\n// lib/token.ts\n\nconst secret = new TextEncoder().encode(process.env.QR_JWT_SECRET);\n// Para tarjetas físicas (token estable)\nasync function makeCardToken(userId) {\n    return await new jose__WEBPACK_IMPORTED_MODULE_0__.SignJWT({\n        sub: userId,\n        kind: \"card\"\n    }).setProtectedHeader({\n        alg: \"HS256\"\n    }).sign(secret); // sin expiración\n}\nasync function verifyQrToken(token) {\n    const { payload } = await jose__WEBPACK_IMPORTED_MODULE_1__.jwtVerify(token, secret, {\n        algorithms: [\n            \"HS256\"\n        ]\n    });\n    return payload; // { sub, kind?, tv?, tier? }\n}\n//# sourceURL=[module]\n//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiKHJzYykvLi9saWIvdG9rZW4udHMiLCJtYXBwaW5ncyI6Ijs7Ozs7OztBQUFBLGVBQWU7QUFDYztBQUU3QixNQUFNQyxTQUFTLElBQUlDLGNBQWNDLE1BQU0sQ0FBQ0MsUUFBUUMsR0FBRyxDQUFDQyxhQUFhO0FBRWpFLHdDQUF3QztBQUNqQyxlQUFlQyxjQUFjQyxNQUFjO0lBQ2hELE9BQU8sTUFBTSxJQUFJUix5Q0FBWSxDQUFDO1FBQUVVLEtBQUtGO1FBQVFHLE1BQU07SUFBTyxHQUN2REMsa0JBQWtCLENBQUM7UUFBRUMsS0FBSztJQUFRLEdBQ2xDQyxJQUFJLENBQUNiLFNBQVMsaUJBQWlCO0FBQ3BDO0FBRU8sZUFBZWMsY0FBY0MsS0FBYTtJQUMvQyxNQUFNLEVBQUVDLE9BQU8sRUFBRSxHQUFHLE1BQU1qQiwyQ0FBYyxDQUFDZ0IsT0FBT2YsUUFBUTtRQUN0RGtCLFlBQVk7WUFBQztTQUFRO0lBQ3ZCO0lBQ0EsT0FBT0YsU0FBUyw2QkFBNkI7QUFDL0MiLCJzb3VyY2VzIjpbIndlYnBhY2s6Ly9wbGF0YWZvcm1hLWRlc2N1ZW50b3MvLi9saWIvdG9rZW4udHM/Njk4NCJdLCJzb3VyY2VzQ29udGVudCI6WyIvLyBsaWIvdG9rZW4udHNcbmltcG9ydCAqIGFzIGpvc2UgZnJvbSBcImpvc2VcIjtcblxuY29uc3Qgc2VjcmV0ID0gbmV3IFRleHRFbmNvZGVyKCkuZW5jb2RlKHByb2Nlc3MuZW52LlFSX0pXVF9TRUNSRVQhKTtcblxuLy8gUGFyYSB0YXJqZXRhcyBmw61zaWNhcyAodG9rZW4gZXN0YWJsZSlcbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBtYWtlQ2FyZFRva2VuKHVzZXJJZDogc3RyaW5nKSB7XG4gIHJldHVybiBhd2FpdCBuZXcgam9zZS5TaWduSldUKHsgc3ViOiB1c2VySWQsIGtpbmQ6IFwiY2FyZFwiIH0pXG4gICAgLnNldFByb3RlY3RlZEhlYWRlcih7IGFsZzogXCJIUzI1NlwiIH0pXG4gICAgLnNpZ24oc2VjcmV0KTsgLy8gc2luIGV4cGlyYWNpw7NuXG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiB2ZXJpZnlRclRva2VuKHRva2VuOiBzdHJpbmcpIHtcbiAgY29uc3QgeyBwYXlsb2FkIH0gPSBhd2FpdCBqb3NlLmp3dFZlcmlmeSh0b2tlbiwgc2VjcmV0LCB7XG4gICAgYWxnb3JpdGhtczogW1wiSFMyNTZcIl0sXG4gIH0pO1xuICByZXR1cm4gcGF5bG9hZDsgLy8geyBzdWIsIGtpbmQ/LCB0dj8sIHRpZXI/IH1cbn1cbiJdLCJuYW1lcyI6WyJqb3NlIiwic2VjcmV0IiwiVGV4dEVuY29kZXIiLCJlbmNvZGUiLCJwcm9jZXNzIiwiZW52IiwiUVJfSldUX1NFQ1JFVCIsIm1ha2VDYXJkVG9rZW4iLCJ1c2VySWQiLCJTaWduSldUIiwic3ViIiwia2luZCIsInNldFByb3RlY3RlZEhlYWRlciIsImFsZyIsInNpZ24iLCJ2ZXJpZnlRclRva2VuIiwidG9rZW4iLCJwYXlsb2FkIiwiand0VmVyaWZ5IiwiYWxnb3JpdGhtcyJdLCJzb3VyY2VSb290IjoiIn0=\n//# sourceURL=webpack-internal:///(rsc)/./lib/token.ts\n");

/***/ })

};
;

// load runtime
var __webpack_require__ = require("../../../webpack-runtime.js");
__webpack_require__.C(exports);
var __webpack_exec__ = (moduleId) => (__webpack_require__(__webpack_require__.s = moduleId))
var __webpack_exports__ = __webpack_require__.X(0, ["vendor-chunks/next@14.2.5_react-dom@18.3.1_react@18.3.1__react@18.3.1","vendor-chunks/jose@5.10.0"], () => (__webpack_exec__("(rsc)/./node_modules/.pnpm/next@14.2.5_react-dom@18.3.1_react@18.3.1__react@18.3.1/node_modules/next/dist/build/webpack/loaders/next-app-loader.js?name=app%2Fapi%2Fredeem%2Froute&page=%2Fapi%2Fredeem%2Froute&appPaths=&pagePath=private-next-app-dir%2Fapi%2Fredeem%2Froute.ts&appDir=C%3A%5CUsers%5CPC%5CDownloads%5Cplataforma_descuentos_full%5Capp&pageExtensions=tsx&pageExtensions=ts&pageExtensions=jsx&pageExtensions=js&rootDir=C%3A%5CUsers%5CPC%5CDownloads%5Cplataforma_descuentos_full&isDev=true&tsconfigPath=tsconfig.json&basePath=&assetPrefix=&nextConfigOutput=&preferredRegion=&middlewareConfig=e30%3D!")));
module.exports = __webpack_exports__;

})();